<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>图片上传那些事——upload | Fog3211</title>
    <meta name="description" content="图片上传那些事——upload">
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
  <link rel="manifest" href="/manifest.json">
    <meta name="keywords" content="upload">
    <link rel="preload" href="/assets/css/0.styles.cdd2a29b.css" as="style"><link rel="preload" href="/assets/js/app.20bb5225.js" as="script"><link rel="preload" href="/assets/js/51.16da791b.js" as="script"><link rel="prefetch" href="/assets/js/10.8a9c4f08.js"><link rel="prefetch" href="/assets/js/11.8783f7cc.js"><link rel="prefetch" href="/assets/js/12.5ba97642.js"><link rel="prefetch" href="/assets/js/13.1555b7ad.js"><link rel="prefetch" href="/assets/js/14.86f2088d.js"><link rel="prefetch" href="/assets/js/15.fe266707.js"><link rel="prefetch" href="/assets/js/16.15fb79aa.js"><link rel="prefetch" href="/assets/js/17.1a463419.js"><link rel="prefetch" href="/assets/js/18.7c246c5a.js"><link rel="prefetch" href="/assets/js/19.61ef187a.js"><link rel="prefetch" href="/assets/js/2.81a45b37.js"><link rel="prefetch" href="/assets/js/20.7a9b2f72.js"><link rel="prefetch" href="/assets/js/21.b4f5ca00.js"><link rel="prefetch" href="/assets/js/22.3f4573be.js"><link rel="prefetch" href="/assets/js/23.e2af9378.js"><link rel="prefetch" href="/assets/js/24.785952aa.js"><link rel="prefetch" href="/assets/js/25.7ae5ad53.js"><link rel="prefetch" href="/assets/js/26.36e42edb.js"><link rel="prefetch" href="/assets/js/27.3409191d.js"><link rel="prefetch" href="/assets/js/28.393153e4.js"><link rel="prefetch" href="/assets/js/29.dfc25383.js"><link rel="prefetch" href="/assets/js/3.c6d0cc46.js"><link rel="prefetch" href="/assets/js/30.71df5033.js"><link rel="prefetch" href="/assets/js/31.df5404b7.js"><link rel="prefetch" href="/assets/js/32.f1e5ef7c.js"><link rel="prefetch" href="/assets/js/33.3a7e0b72.js"><link rel="prefetch" href="/assets/js/34.bad16bb7.js"><link rel="prefetch" href="/assets/js/35.70e4cf71.js"><link rel="prefetch" href="/assets/js/36.121c4657.js"><link rel="prefetch" href="/assets/js/37.bf6ac364.js"><link rel="prefetch" href="/assets/js/38.fc37e97c.js"><link rel="prefetch" href="/assets/js/39.d04e3ead.js"><link rel="prefetch" href="/assets/js/4.bc59a004.js"><link rel="prefetch" href="/assets/js/40.6a269460.js"><link rel="prefetch" href="/assets/js/41.2ac7fb97.js"><link rel="prefetch" href="/assets/js/42.73ab3bd7.js"><link rel="prefetch" href="/assets/js/43.f9273bf5.js"><link rel="prefetch" href="/assets/js/44.0ea4214a.js"><link rel="prefetch" href="/assets/js/45.eb95c47a.js"><link rel="prefetch" href="/assets/js/46.e5a1623a.js"><link rel="prefetch" href="/assets/js/47.3ae1611c.js"><link rel="prefetch" href="/assets/js/48.da7834c4.js"><link rel="prefetch" href="/assets/js/49.cf1add44.js"><link rel="prefetch" href="/assets/js/5.1cecc36c.js"><link rel="prefetch" href="/assets/js/50.7d5dfb82.js"><link rel="prefetch" href="/assets/js/52.23ddb970.js"><link rel="prefetch" href="/assets/js/53.2de2eea4.js"><link rel="prefetch" href="/assets/js/54.c02fc9ea.js"><link rel="prefetch" href="/assets/js/55.b391fb5b.js"><link rel="prefetch" href="/assets/js/56.0c72f5c7.js"><link rel="prefetch" href="/assets/js/57.22a17b28.js"><link rel="prefetch" href="/assets/js/58.533c918b.js"><link rel="prefetch" href="/assets/js/59.96ac7904.js"><link rel="prefetch" href="/assets/js/6.7fdb8414.js"><link rel="prefetch" href="/assets/js/60.4e089b8c.js"><link rel="prefetch" href="/assets/js/61.7b17150b.js"><link rel="prefetch" href="/assets/js/62.937e58de.js"><link rel="prefetch" href="/assets/js/63.cb70c672.js"><link rel="prefetch" href="/assets/js/7.f5fab6ae.js"><link rel="prefetch" href="/assets/js/8.770acd1e.js"><link rel="prefetch" href="/assets/js/9.93643764.js">
    <link rel="stylesheet" href="/assets/css/0.styles.cdd2a29b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div><div class="wrap"><div class="theme-container container no-sidebar"><header class="navbar"><div class="nav-header"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/head.png" class="logo"> <span class="site-name can-hide">
        Fog3211
      </span></a> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link router-link-active">文章</a></div><div class="nav-item"><a href="/resume/" class="nav-link">简历</a></div><div class="nav-item"><a href="/tags/" class="nav-link">标签</a></div><div class="nav-item"><a href="https://github.com/fog3211" target="_blank" rel="noopener noreferrer" class="nav-link">Github</a></div> <!----></nav> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link router-link-active">文章</a></div><div class="nav-item"><a href="/resume/" class="nav-link">简历</a></div><div class="nav-item"><a href="/tags/" class="nav-link">标签</a></div><div class="nav-item"><a href="https://github.com/fog3211" target="_blank" rel="noopener noreferrer" class="nav-link">Github</a></div> <!----></nav> <!----></div> <div class="page-container"><div><div class="page card"><div class="content-header"><h1 class="page-title">
        图片上传那些事——upload
      </h1> <span class="page-timestamp">2019-10-14 19:10:00</span></div> <div class="content"><p>本文将介绍在upload上传图片时的一些坑点。
</p> <h2 id="介绍"><a href="#介绍" aria-hidden="true" class="header-anchor">#</a> 介绍</h2> <p>    经常做web开发的话同学应该对图片上传不陌生，使用upload组件比较简单方便，但是最近被两个很简单的需求给难住了，（上传图片是需要先校验，删除前需要弹框提示）这两个点单拿出一个来都是很容易的，但是放在一起就很头疼了。</p> <h2 id="正文"><a href="#正文" aria-hidden="true" class="header-anchor">#</a> 正文</h2> <h3 id="环境搭建"><a href="#环境搭建" aria-hidden="true" class="header-anchor">#</a> 环境搭建</h3> <p>本例使用的是<code>element-ui</code>的<code>el-upload</code>，其他类似组件也差不多。</p> <h3 id="上传校验"><a href="#上传校验" aria-hidden="true" class="header-anchor">#</a> 上传校验</h3> <p>    思路比较简单，使用文档提供好的钩子函数<code>beforeUpload</code>在上传之前检查即可。</p> <p>下面就是对图片大小及格式的检查：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> type<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'image/jpeg'</span><span class="token punctuation">,</span> <span class="token string">'image/png'</span><span class="token punctuation">]</span>
<span class="token function">beforeUpload</span><span class="token punctuation">(</span><span class="token parameter">file<span class="token punctuation">,</span> type<span class="token punctuation">,</span> size</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> fileType <span class="token operator">=</span> type<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>type<span class="token punctuation">)</span>
    <span class="token keyword">const</span> sizeLimit <span class="token operator">=</span> file<span class="token punctuation">.</span>size <span class="token operator">/</span> <span class="token number">1024</span> <span class="token operator">&lt;</span> size

    vm<span class="token punctuation">.</span>isUpload <span class="token operator">=</span> <span class="token boolean">true</span>

    <span class="token comment">// 图片格式</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fileType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    vm<span class="token punctuation">.</span>$message<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'上传图片只支持JPG或PNG格式！'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 图片大小</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sizeLimit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    vm<span class="token punctuation">.</span>$message<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`上传图片大小不能超过</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>size<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">k！`</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> file
<span class="token punctuation">}</span>
</code></pre></div><p>    当然，用过<code>el-upload</code>的人可能会发现，这个传参和钩子函数的不一致，是不是直接</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">:</span>before<span class="token operator">-</span>upload<span class="token operator">=</span><span class="token string">&quot;beforeUpload(file, &quot;</span>image<span class="token operator">/</span>png<span class="token string">&quot;, 200)&quot;</span>
</code></pre></div><p>这样就行了呢？当然不会这么简单（其实就是很简单），我们需要在外面在加一个箭头函数。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 像这样，file是钩子本身的参数，后面的函数里放自定义的参数</span>
<span class="token punctuation">:</span>before<span class="token operator">-</span>upload<span class="token operator">=</span><span class="token string">&quot;(file)=&gt;beforeUpload(file, &quot;</span>image<span class="token operator">/</span>png<span class="token string">&quot;, 200)&quot;</span>
</code></pre></div><p>其他钩子一样的用法（<code>on-success</code>,<code>before-remove</code>等等）</p> <p>当然这只是最简单的一步，下面我们要限制图片的分辨率（宽高），先来个无脑一点的办法：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">beforeUpload</span><span class="token punctuation">(</span><span class="token parameter">file<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">var</span> _img <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _img<span class="token punctuation">.</span><span class="token function">readAsDataURL</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    _img<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">theFile</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> image <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    image<span class="token punctuation">.</span>src <span class="token operator">=</span> theFile<span class="token punctuation">.</span>target<span class="token punctuation">.</span>result<span class="token punctuation">;</span>
    image<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token comment">// 不符合要求</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_this<span class="token punctuation">.</span>width <span class="token operator">!=</span> width <span class="token operator">||</span> _this<span class="token punctuation">.</span>height <span class="token operator">!=</span> height<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                vm<span class="token punctuation">.</span>$message<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>
                <span class="token string">&quot;上传图片尺寸应为&quot;</span> <span class="token operator">+</span> w <span class="token operator">+</span> <span class="token string">&quot;*&quot;</span> <span class="token operator">+</span> h <span class="token operator">+</span> <span class="token string">&quot;，请重新上传&quot;</span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                <span class="token comment">// 上传操作.....</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>    然后就会惊奇的发现并没有什么用，仔细分析一下的话：读取image是异步操作，在执行<code>return false</code>的时候其实已经执行完<code>beforeUpload</code>任务了。<br>
    之前看其他文章分析说是因为返回的应该是promise而不是false，但我不是很同意这种说法，返回false无效的原因是js的异步机制导致的，可以参考校验图片大小时返回false依然可以阻止上传。</p> <p><a href="https://element.eleme.cn/#/zh-CN/component/upload" target="_blank" rel="noopener noreferrer">官网文档说明<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：</p> <p><img src="https://img.fog3211.com/$P%60MUWV4G7IDKM2RGOEBB2.png" alt="avatar"></p> <p><a href="https://github.com/ElemeFE/element/blob/dev/packages/upload/src/upload.vue" target="_blank" rel="noopener noreferrer">el-upload源码<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>:</p> <p><img src="https://img.fog3211.com/Q0%7BN%28KE@TTX%7DMLCEFPL@%7BKF.png" alt="avatar"></p> <p>可以看到源码里面写的是当before为假或reject时触发删除操作（即取消上传）。</p> <p>修改后的代码可以是这样的：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">beforeUpload</span><span class="token punctuation">(</span><span class="token parameter">file<span class="token punctuation">,</span>width<span class="token punctuation">,</span>height</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 使用Promise处理链式操作</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> _URL <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token constant">URL</span> <span class="token operator">||</span> window<span class="token punctuation">.</span>webkitURL
        <span class="token keyword">const</span> image <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        image<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> valid <span class="token operator">=</span> image<span class="token punctuation">.</span>width <span class="token operator">===</span> width <span class="token operator">&amp;&amp;</span> image<span class="token punctuation">.</span>height <span class="token operator">===</span> height
          valid <span class="token operator">?</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        image<span class="token punctuation">.</span>src <span class="token operator">=</span> _URL<span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> file
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          vm<span class="token punctuation">.</span>$message<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>
            <span class="token string">'上传图片尺寸应为'</span> <span class="token operator">+</span> width <span class="token operator">+</span> <span class="token string">'*'</span> <span class="token operator">+</span> height <span class="token operator">+</span> <span class="token string">'，请重新上传'</span>
          <span class="token punctuation">)</span>
        <span class="token comment">//   return false</span>
          <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="删除确认"><a href="#删除确认" aria-hidden="true" class="header-anchor">#</a> 删除确认</h3> <p>    上传前的校验完成了，下面是删除确认。先把它单独摘出来：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 直接调用before-remove钩子即可</span>
 <span class="token function">beforeRemove</span><span class="token punctuation">(</span><span class="token parameter">file<span class="token punctuation">,</span> imgList</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>
        <span class="token punctuation">.</span><span class="token function">$confirm</span><span class="token punctuation">(</span><span class="token string">'确定删除该张图片吗？'</span><span class="token punctuation">,</span> <span class="token string">'确认删除'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
          confirmButtonText<span class="token punctuation">:</span> <span class="token string">'确定'</span><span class="token punctuation">,</span>
          cancelButtonText<span class="token punctuation">:</span> <span class="token string">'取消'</span><span class="token punctuation">,</span>
          type<span class="token punctuation">:</span> <span class="token string">'warning'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// 删除操作....</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// 取消删除....</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>到这里问题还是非常简单的，但是一旦把上面两个功能组合起来；就会发现：</p> <p>正常删除时如预期一致，但是上传一张不符合要求的图片，就会弹出删除确认，这是为什么？？不是取消上传了吗，怎么还会有删除操作？？</p> <p>原来看一下源码发现在<code>before-upload</code>中，取消上传实际上是<code>先上传-》再删除</code>的。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// element-ui源码</span>

 <span class="token function">upload</span><span class="token punctuation">(</span><span class="token parameter">rawFile</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>$refs<span class="token punctuation">.</span>input<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>beforeUpload<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>rawFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">const</span> before <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">beforeUpload</span><span class="token punctuation">(</span>rawFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>before <span class="token operator">&amp;&amp;</span> before<span class="token punctuation">.</span>then<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        before<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">processedFile</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> fileType <span class="token operator">=</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>processedFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>fileType <span class="token operator">===</span> <span class="token string">'[object File]'</span> <span class="token operator">||</span> fileType <span class="token operator">===</span> <span class="token string">'[object Blob]'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>fileType <span class="token operator">===</span> <span class="token string">'[object Blob]'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              processedFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token punctuation">[</span>processedFile<span class="token punctuation">]</span><span class="token punctuation">,</span> rawFile<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token punctuation">{</span>
                type<span class="token punctuation">:</span> rawFile<span class="token punctuation">.</span>type
              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> p <span class="token keyword">in</span> rawFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>rawFile<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                processedFile<span class="token punctuation">[</span>p<span class="token punctuation">]</span> <span class="token operator">=</span> rawFile<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>processedFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>rawFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onRemove</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> rawFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>before <span class="token operator">!==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>rawFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//此处不符合要求的图片会调用remove函数</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onRemove</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> rawFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><h3 id="终极方案"><a href="#终极方案" aria-hidden="true" class="header-anchor">#</a> 终极方案</h3> <p>    对于上面的问题，我们肯定会想到加一个flag进行区分是在上传是删除还是直接删除，但是如果直接加载<code>before-remove</code>或者<code>on-remove</code>钩子里面，会发现并没有什么用（因为upload回调remove时会先触发<code>before-remove</code>，因此这样只是徒劳）。</p> <div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>另外提一句，如果是使用<code>http-request</code>这个钩子进行自定义上传（大多数的做法），像<code>on-success</code>，<code>on-remove</code>这种钩子都会失效。</p></div> <p>    好在我们可以使用自定义的<code>http-request</code>钩子，它会在文件上传时触发,具体时机应该是这样的：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>before-upload
  -<span class="token operator">&gt;</span> 成功：  http-request<span class="token punctuation">..</span>.
  -<span class="token operator">&gt;</span> 失败：  before-remove  on-remove<span class="token punctuation">..</span>.
</code></pre></div><p>代码简写如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">{</span>
     <span class="token comment">// 删除标识：true为不符合格式要求（无弹框） false为正常删除（有确认弹框）</span>
        isUpload<span class="token punctuation">:</span><span class="token boolean">false</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
methods<span class="token punctuation">:</span><span class="token punctuation">{</span>
    <span class="token comment">// 绑定http-request的函数</span>
    <span class="token function">upLoadRequest</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> file <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>isUpload <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token comment">// 其他操作...</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 绑定before-upload的函数</span>
    <span class="token function">beforeUpload</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">this</span><span class="token punctuation">.</span>isUpload <span class="token operator">=</span> <span class="token boolean">true</span>
   <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">beforeRemove</span><span class="token punctuation">(</span><span class="token parameter">file<span class="token punctuation">,</span> imgList</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// 不符合要求删除</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>isUpload<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 其他操作....</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>isUpload <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span>
    <span class="token comment">//   正常删除操作....</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>    这样每次上传前将flag设为upload，不符合要求的话触发删除并将flag改回默认值即可。这样就实现了删除状态的区分。</p></div> <!----> <div class="content page-nav"><p class="inner"><span class="prev">
          ← <a href="/blog/keep-vuex.html" class="prev">
            刷新页面保存Vuex状态
          </a></span> <span class="next"><a href="/blog/v-if%26v-show.html">
            关于v-if和v-show的踩坑记录
          </a> →
        </span></p></div></div> <div id="comment-container"><div class="gt-container"><div class="gt-initing"><i class="gt-loader"></i> <p class="gt-initing-text">Gitalking ...</p></div> <!----> <!----> <div><div class="gt-header"><a class="gt-avatar-github"><span class="gt-ico gt-ico-github"><span class="gt-svg"><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M64 524C64 719.602 189.356 885.926 364.113 947.017 387.65799 953 384 936.115 384 924.767L384 847.107C248.118 863.007 242.674 773.052 233.5 758.001 215 726.501 171.5 718.501 184.5 703.501 215.5 687.501 247 707.501 283.5 761.501 309.956 800.642 361.366 794.075 387.658 787.497 393.403 763.997 405.637 743.042 422.353 726.638 281.774 701.609 223 615.67 223 513.5 223 464.053 239.322 418.406 271.465 381.627 251.142 320.928 273.421 269.19 276.337 261.415 334.458 256.131 394.888 302.993 399.549 306.685 432.663 297.835 470.341 293 512.5 293 554.924 293 592.81 297.896 626.075 306.853 637.426 298.219 693.46 258.054 747.5 262.966 750.382 270.652 772.185 321.292 753.058 381.083 785.516 417.956 802 463.809 802 513.5 802 615.874 742.99 701.953 601.803 726.786 625.381 750.003 640 782.295 640 818.008L640 930.653C640.752 939.626 640 948.664978 655.086 948.665 832.344 888.962 960 721.389 960 524 960 276.576 759.424 76 512 76 264.577 76 64 276.576 64 524Z"></path>
</svg>
</span> <!----></span></a> <div class="gt-header-comment"><textarea placeholder="Leave a comment" class="gt-header-textarea"></textarea> <div class="gt-header-preview markdown-body hide"></div> <div class="gt-header-controls"><a href="https://guides.github.com/features/mastering-markdown/" target="_blank" class="gt-header-controls-tip"><span class="gt-ico gt-ico-tip"><span class="gt-svg"><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M512 366.949535c-16.065554 0-29.982212 13.405016-29.982212 29.879884l0 359.070251c0 16.167882 13.405016 29.879884 29.982212 29.879884 15.963226 0 29.879884-13.405016 29.879884-29.879884L541.879884 396.829419C541.879884 380.763865 528.474868 366.949535 512 366.949535L512 366.949535z"
    p-id="3083"></path>
  <path d="M482.017788 287.645048c0-7.776956 3.274508-15.553912 8.80024-21.181973 5.525732-5.525732 13.302688-8.80024 21.181973-8.80024 7.776956 0 15.553912 3.274508 21.079644 8.80024 5.525732 5.62806 8.80024 13.405016 8.80024 21.181973 0 7.776956-3.274508 15.656241-8.80024 21.181973-5.525732 5.525732-13.405016 8.697911-21.079644 8.697911-7.879285 0-15.656241-3.274508-21.181973-8.697911C485.292295 303.301289 482.017788 295.524333 482.017788 287.645048L482.017788 287.645048z"
    p-id="3084"></path>
  <path d="M512 946.844409c-239.8577 0-434.895573-195.037873-434.895573-434.895573 0-239.8577 195.037873-434.895573 434.895573-434.895573 239.755371 0 434.895573 195.037873 434.895573 434.895573C946.895573 751.806535 751.755371 946.844409 512 946.844409zM512 126.17088c-212.740682 0-385.880284 173.037274-385.880284 385.777955 0 212.740682 173.037274 385.777955 385.880284 385.777955 212.740682 0 385.777955-173.037274 385.777955-385.777955C897.777955 299.208154 724.740682 126.17088 512 126.17088z"
    p-id="3085"></path>
</svg>
</span> <span class="gt-ico-text">Markdown is supported</span></span></a> <!----> <button class="gt-btn gt-btn-preview"><span class="gt-btn-text">Preview</span> <!----></button> <button class="gt-btn gt-btn-login"><span class="gt-btn-text">Login with GitHub</span> <!----></button></div></div></div> <div class="gt-comments"><span></span> <p class="gt-comments-null">
                Be the first guy leaving a comment!
            </p> <!----></div></div></div></div></div> <!----></div> <div class="tool-group"><!----></div></div> <!----></div> <div class="background-mask" style="background:#f6f6f6;"></div></div></div>
    <script src="/assets/js/app.20bb5225.js" defer></script><script src="/assets/js/51.16da791b.js" defer></script>
  </body>
</html>
